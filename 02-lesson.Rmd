# Loading data

Let's begin by reading in the Stanford Policing Project State Patrol data for the state of Colorado; the data can be downloaded from this [website](https://openpolicing.stanford.edu/data/), but has also been made available to you as part of the workshop materials as a CSV file. Once, the traffic patrol data has been downloaded into your working directory, pass the name of the file to the ```read_csv``` function, and assign it to an object. Here, we'll assign the traffic patrol data to an object named ```co_traffic_stops```. Note that object names are arbitrary, but ideally should meaningfully describe their contents. 

```{r, eval=FALSE}
# Read in Stanford police data for Colorado and assign to object named "co_traffic_stops"
co_traffic_stops<-read_csv("co_statewide_2020_04_01.csv")
```

```{r, cache=TRUE, echo=F}
co_traffic_stops<-read_csv("https://www.dropbox.com/s/r7oydximjp46ylh/co_statewide_2020_04_01.csv?dl=1")
```

Once the traffic patrol data has been read into R studio and assigned to the object, we can print the contents of the dataset to the console by typing the name of the object into the R Studio console (note that only the first few records will be printed)

```{r}
# Print the contents of "co_traffic_stops" (i.e. the CO traffic patrol data) to the console; the first few records of the dataset will print
co_traffic_stops
```

We can also view ```co_traffic_stops``` object (or, for that matter, any dataset in R Studio) within the R Studio data viewer by passing the name of the object to the ```View``` function:

```{r}
# Inspect ```co_traffic_stops``` in the R Studio data viewer
View(co_traffic_stops)
```

# Cleaning and filtering data

To make things tractable (after all, the entire dataset has more than 3,000,000 observations), let's focus our attention on Colorado traffic patrol from the year 2010; this also has the advantage of allowing us to eventually use 2010 census data in crafting our measure of racial bias in traffic stops. Note that currently, there isn't a separate field which contains the year in which a particular stop took place; rather, there is a "date" field, in which the date is stored in YYYY-MM-DD format. The easiest way to extract observations from the year 2010 is therefore to first extract the YYYY information from the "date" field, and use that information to make a new "Year" field, which only contains the year of a given stop. 

## Create a "Year" field

To create this new "Year" field within ```co_traffic_stops```, we can use the ```mutate``` function, which is a ```tidyverse``` function that allows us to define new variables within a dataset, and the ```substr``` function, which allows us to extract a subset of a given string.

The code below takes the data in the ```co_traffic_stops``` object, and then (``` %>% ```) creates a new field named "Year" using the ```mutate``` function; this field is set equal to the the first four digits of the existing "date" field by passing ```co_traffic_stops$data, 1, 4``` to the ```substr``` function: 

```{r}
# Creates "Year" field, that contains the year of a given stop, in "co_traffic_stops"
co_traffic_stops<-co_traffic_stops %>% 
                    mutate(Year=substr(co_traffic_stops$date, 1,4))
```

We can check to make sure that the "Year" field has been successfully created by viewing ```co_traffic_stops``` in the R Studio data viewer with ```View(co_traffic_stops)```.

## Filter by year

Now that we have created the "Year" field, we can use it to filter the 2010 observations, and assign the 2010 stops to a new object named ```co_traffic_stops_2010```:

```{r}
# Filter 2010 observations and assign to a new object
co_traffic_stops_2010<-co_traffic_stops %>% filter(Year==2010)
```

```{r, echo=FALSE}
co_traffic_stops_2010<-co_traffic_stops_2010 %>% relocate(date, Year, county_name, subject_race)
```

When we print the contents of the newly created ```co_traffic_stops_2010``` object, note that the observations are now only from 2010. 

```{r}
# Print contents of "co_traffic_stops_2010" object
co_traffic_stops_2010
```

# Transforming Data

Now that we have created a new data object that contains information on traffic stops from our year of interest (2010), let's do a bit of work with the data so that we can find out the total number of traffic stops within each county, and the number of stops within each county in which the person stopped by the traffic police was Black. 

## Tabulate county-level count of traffic stops by race

First, let's find out the racial breakdown of stops for each county, using the data in the "subject_race" field of ```co_traffice_stops_2010```.

Below, we take ```co_traffic_stops_2010``` object, declare "county_name" as a grouping variable using ```group_by(county_name)```, and then count up the number of stops associated with each racial category within each county using ```count(subject_race)```. The dataset thats results from these operations is assigned to a new object named ```co_county_summary```:

```{r}
# Compute county-level count of traffic stops by race
co_county_summary<-co_traffic_stops_2010 %>% 
                    group_by(county_name) %>% 
                    count(subject_race) 
```

Let's print the first few rows from the dataset and observe its structure:

```{r}
co_county_summary
```

## Reshape the data

```{r}
co_county_summary_wide<-co_county_summary %>% 
                        pivot_wider(names_from=subject_race, values_from=n)
```

## Calculate total stops for each county in ```co_county_summary_wide```

```{r}
co_county_summary_wide<-co_county_summary_wide %>% 
                        rowwise() %>% 
                        mutate(total_stops=sum(c_across(where(is.integer)), na.rm=TRUE)) 
```

```{r}
co_county_summary_wide
```

## Clean ```co_county_summary_wide``` and assign to new object

```{r}
co_county_black_stops<-co_county_summary_wide %>%
                        select(county_name, black, total_stops) 
                        
```

```{r}
co_county_black_stops<-co_county_black_stops %>%
                        rename(black_stops=black)
```


```{r}
co_county_black_stops<-co_county_black_stops %>% 
                        filter(county_name!="NA")

```

```{r}
co_county_black_stops
```

# Defining an index of racial bias in traffic stops

## Read in and join 2010 census data to ```co_county_black_stops```

Read in census data

```{r, eval=FALSE}
co_counties_census_2010<-read_csv("co_county_decennial_census.csv")
```

```{r, echo=FALSE}
# Read in census data and assigns to object named "co_counties_census_2010"
co_counties_census_2010<-read_csv("https://www.dropbox.com/s/kq94707fmcdbc0w/co_county_decennial_census.csv?dl=1") 
```

```{r}
# Prints contents of "co_counties_census_2010"
co_counties_census_2010
```

## Join census data to ```co_county_black_stops```

```{r}
co_counties_census_trafficstops<-full_join(co_county_black_stops, co_counties_census_2010,
                                           by=c("county_name"="County"))
```

```{r}
co_counties_census_trafficstops
```

## Define the variables that will be used in the bias index

```{r}
co_counties_census_trafficstops<-co_counties_census_trafficstops %>% 
                                    mutate(black_stop_pct=((black_stops/total_stops)*100),
                                           black_pop_pct=((total_black_pop_over17/total_pop_over17)*100))
```

```{r}
co_counties_census_trafficstops
```

## Calculate the bias index

```{r}
co_counties_census_trafficstops<-co_counties_census_trafficstops %>% 
                                  mutate(excess_stops_index=black_stop_pct-black_pop_pct)
```

```{r}
co_counties_census_trafficstops
```

## Compute summary statistics for the bias index

```{r}
describe(co_counties_census_trafficstops$excess_stops_index)
```

## Visualize county-level variation in the bias index using ```ggplot```

```{r}
co_counties_census_trafficstops<-co_counties_census_trafficstops %>% 
                                 mutate(County=str_remove(county_name, " County"))
```

```{r}
bias_graph<-co_counties_census_trafficstops %>% 
            drop_na(excess_stops_index) %>% 
            ggplot()+
            geom_col(aes(x=reorder(County, excess_stops_index), y=excess_stops_index))+
            coord_flip()+
            labs(title="Racial Discrimination in Police Stops, by County (Colorado)", x="County", y="Bias Index=\nBlack Percentage of Overall Traffic Stops â€“ Black Percentage of Overall Over-17 Population")+
            theme(axis.title.x = element_text(size = 9))+      
            scale_y_continuous(breaks=c(-10, -7.5, -5, -2.5, 0, 2.5, 5, 7.5))+
            expand_limits(y=c(-10,10))+
            theme(plot.title=element_text(hjust=0.5)) 
```

```{r, fig.width=8, fig.height=10}
bias_graph
```

# Mapping the bias index

## Read in and view the shapefile of CO counties

```{r, echo=-1}
setwd("/Users/adra7980/Documents/CU_workshops/gis/data/tl_2019_08_county")
# Reads in shapefile and assigns to object named "co_counties_shapefile"
co_counties_shapefile<-st_read("tl_2019_08_county.shp")
```

```{r}
co_counties_shapefile
```

```{r, fig.asp=0.5, echo=-1}
tmap_mode("plot")
tm_shape(co_counties_shapefile)+
  tm_polygons()
```

```{r}
co_counties_map<-tm_shape(co_counties_shapefile)+
                    tm_polygons()
```

```{r, fig.asp=0.5}
co_counties_map
```

```{r}
tmap_mode("view")
```

```{r}
co_counties_map
```

```{r}
tmap_mode("plot")
```

```{r, fig.asp=0.5}
co_counties_map
```

## Join ```co_counties_census_trafficstops``` to the shapefile of Colorado counties

```{r}
county_shapefile_biasIndex<-full_join(co_counties_shapefile, co_counties_census_trafficstops, 
                                   by="GEOID")
```

```{r}
county_shapefile_biasIndex
```

## Display the bias index on a map of Colorado counties

### Make a rough draft of a map 

```{r, fig.asp=0.5}
traffic_stop_bias_map<-tm_shape(county_shapefile_biasIndex)+
                  tm_polygons(col="excess_stops_index", 
                              palette="YlOrRd", 
                              textNA="No Data", 
                              n=5, 
                              style="jenks", 
                              midpoint=F)+
                  tm_layout(frame=FALSE, 
                            legend.outside=TRUE)

traffic_stop_bias_map
```

### Make a map with custom breaks

```{r, fig.asp=0.5}
traffic_stop_bias_map<-tm_shape(county_shapefile_biasIndex)+
                  tm_polygons(col="excess_stops_index", 
                              palette="YlOrRd", 
                              textNA="No Data", 
                              n=5, 
                              breaks=c(-10,-5, 0, 2, 4, 5),
                              midpoint=F)+
                  tm_layout(frame=FALSE, 
                            legend.outside=TRUE)
traffic_stop_bias_map
```

### Make a map with custom colors 

```{r, fig.asp=0.5}
my_colors<-c("white", "peachpuff", "red1", "red4", "navy")
traffic_stop_bias_map<-tm_shape(county_shapefile_biasIndex)+
                  tm_polygons(col="excess_stops_index", 
                              palette=my_colors, 
                              textNA="No Data", 
                              n=5, 
                              breaks=c(-10,-5, 0, 2, 4, 5))+
                  tm_layout(frame=FALSE, 
                            legend.outside=TRUE)
traffic_stop_bias_map
```

### Make a categorical map 

Define categorical column 

```{r}
county_shapefile_biasIndex<-
  county_shapefile_biasIndex %>% 
            mutate(apparent_bias=ifelse(excess_stops_index>0, "Apparent Bias", "No Apparent Bias"))
```

```{r, fig.asp=0.5}
categorical_map<-tm_shape(county_shapefile_biasIndex)+
                    tm_polygons(col="apparent_bias", title="", pal=c("orangered1", "white"), 
                                textNA="No Data")+
                    tm_layout(frame=FALSE, 
                              legend.outside=TRUE)
                    
categorical_map
```


# Refining and formatting the maps of the Colorado traffic-stop bias index

## Refining the map of the continuous bias variable

```{r, echo=F}
county_shapefile_biasIndex<-county_shapefile_biasIndex %>% relocate(NAME)
```

```{r, fig.asp=0.5}
my_colors<-c("white", "peachpuff", "red1", "red4", "navy")
traffic_stop_bias_map<-tm_shape(county_shapefile_biasIndex)+
  tm_polygons(col="excess_stops_index", 
              palette=my_colors,
              title="(Black % of Traffic Stops) - (Black % of Population)",
              textNA="No Data", 
              n=5, 
              breaks=c(-10,-5, 0.01, 2, 4, 5))+
  tm_layout(frame=FALSE, 
            legend.outside=TRUE,
            legend.text.size=0.68,
            legend.title.size=0.75,
            title="Traffic Stop Racial Bias Index",
            title.size=0.75,
            title.fontface = 2,
            main.title="Racial Bias in Traffic Stops, by County (Colorado)",
            main.title.position=0.03,
            main.title.size=1,
            attr.outside=TRUE)+
  tm_credits("Map Author: NAME\nData Sources: 2010 Decennial Census via tidyverse,\nStanford Open Policing Project,\nColorado GeoLibrary ", # Sets text for map credits
                    position=c(0.02,0.01), # Specifies location of map credits
                    size=0.38)

traffic_stop_bias_map
```


```{r}
traffic_stop_bias_labeled<-traffic_stop_bias_map+
                          tm_text("NAME", size=0.30, fontface=2)

traffic_stop_bias_labeled
```

```{r}
tmap_mode("view")

traffic_stop_bias_labeled
```

```{r}
tmap_mode("plot")
```

## Refining the map of the categorical bias variable 

```{r}
categorical_map<-tm_shape(county_shapefile_biasIndex)+
                    tm_polygons(col="apparent_bias", title="", pal=c("orangered1", "white"), 
                                textNA="No Data")+
                    tm_layout(frame=FALSE, 
                              legend.outside=TRUE,
                              main.title="Racial Bias in Traffic Stops, by County (Colorado)",
                              main.title.position=0.03,
                              main.title.size=1,
                              attr.outside=TRUE)+
                 tm_credits("Map Author: NAME\nData Sources: 2010 Decennial Census via tidyverse,\nStanford Open Policing Project,\nColorado GeoLibrary ", # Sets text for map credits
                    position=c(0.02,0.01), # Specifies location of map credits
                    size=0.38)+
  tm_text("NAME", size=0.30, fontface=2)
      
                    
categorical_map
```

# Exporting maps

```{r}
tmap_save(traffic_stop_bias_labeled, "traffic_stop_bias_labeled.png")
```

# Summary script

```{r, eval=F}
# Read in Stanford police data for Colorado and assign to object named "co_traffic_stops" 
co_traffic_stops<-read_csv("co_statewide_2020_04_01.csv")

# Create "Year" field based on existing "date" field
co_traffic_stops<-co_traffic_stops %>% 
                    mutate(Year=substr(co_traffic_stops$date, 1,4))# Filter 2010 observations and assign to a # 
# Filter 2010 observations and assign to a new object named "co_traffic_stops_2010"
co_traffic_stops_2010<-co_traffic_stops %>% filter(Year==2010)

# Compute county-level count of traffic stops by race and assign to object named "co_county_summary"
co_county_summary<-co_traffic_stops_2010 %>% 
                    group_by(county_name) %>% 
                    count(subject_race) 

# Reshape the data so that the racial categories are transposed
# from rows into columns and assign the result to an object named
# "co_county_summary_wide"
co_county_summary_wide<-co_county_summary %>% 
                        pivot_wider(names_from=subject_race, values_from=n)


# Creates a new column named "total_stops" in "co_county_summary_wide" that
# contains information on the total number of stops for each county (across all racial categories)
co_county_summary_wide<-co_county_summary_wide %>% 
                        rowwise() %>% 
                        mutate(total_stops=sum(c_across(where(is.integer)), na.rm=TRUE))

# Selects "county_name", "black", and "total_stops" variables from "co_county_summary_wide";
# then renames the "black" variable to "black_stops" for clarity; then removes counties that
# are named "NA" due to an error in the dataset
co_county_black_stops<-co_county_summary_wide %>%
                        select(county_name, black, total_stops) %>% 
                        rename(black_stops=black) %>% 
                        filter(county_name!="NA")

# Read in the pre-prepared demographic data from the 2010 decennial census and assign
# to an object named "co_counties_census_2010"
co_counties_census_2010<-read_csv("co_county_decennial_census.csv")

# Join "co_counties_census_2010" to "co_county_black_stops" and assign the result
# to an object named "co_counties_census_trafficstops"
co_counties_census_trafficstops<-full_join(co_county_black_stops, co_counties_census_2010,
                                           by=c("county_name"="County"))

# Use the information in "co_counties_census_trafficstops" to define new variables that will be used
# to compute the racial bias index: "black_stop_pct" (the black percentage of overall traffic stops within
# a county) and "black_pop_pct" (the black percentage of the county's over-17 population)

co_counties_census_trafficstops<-
  co_counties_census_trafficstops %>% 
    mutate(black_stop_pct=((black_stops/total_stops)*100),
          black_pop_pct=((total_black_pop_over17/total_pop_over17)*100))

# Calculate the bias index and include it as a new variable in "co_counties_census_trafficstops"
co_counties_census_trafficstops<-co_counties_census_trafficstops %>% 
                                  mutate(excess_stops_index=black_stop_pct-black_pop_pct)

# Reads in Colorado county shapefile and assigns the shapefile to a new object named 
# "co_counties_shapefile"
co_counties_shapefile<-st_read("tl_2019_08_county.shp")

# Join "co_counties_census_trafficstops" to "co_counties_shapefile" using "GEOID" as the join field; 
# assign the result to a new object named "county_shapefile_biasIndex"
county_shapefile_biasIndex<-full_join(co_counties_shapefile, co_counties_census_trafficstops, 
                                   by="GEOID")

# make a map of the continuous "excess_stops_index" 
my_colors<-c("white", "peachpuff", "red1", "red4", "navy") # create color vector
traffic_stop_bias_map<- # object assignment; assigns map to object named "traffic_stop_bias_map"
  tm_shape(county_shapefile_biasIndex)+ # declares the spatial object that is the basis for the map
  tm_polygons(col="excess_stops_index", # declares variable containing data to be mapped
              palette=my_colors, # sets color scheme (based on "my_colors" vector)
              title="(Black % of Traffic Stops) - (Black % of Population)", # sets legend subtitle
              textNA="No Data", # Sets the name of the legend label for "NA" values
              n=5, # defines the number of intervals in the legend
              breaks=c(-10,-5, 0.01, 2, 4, 5))+ # sets custom legend breaks
  tm_layout(frame=FALSE, # removes bounding box
            legend.outside=TRUE, # sets legend outside (invisible) bounding box
            legend.text.size=0.68, # sets size of legend text elements
            legend.title.size=0.75, # sets size of legend main title
            title="Traffic Stop Racial Bias Index", # sets legend's main title
            title.size=0.75, # sets relative size of legend's subtitle
            title.fontface = 2, # Makes legend title bold
            main.title="Racial Bias in Traffic Stops, by County (Colorado)", # specifies main title of map
            main.title.position=0.03, # specifies position of main title
            main.title.size=1, # specifies size of main title
            attr.outside=TRUE)+ # specifies that map credits should be placed outside bounding box
  tm_credits("Map Author: NAME\nData Sources: 2010 Decennial Census via tidyverse,\nStanford Open Policing Project,\nColorado GeoLibrary ", # Sets text for map credits
                    position=c(0.02,0.01), # Specifies location of map credits
                    size=0.38) # sets title of credits

# Prints map
traffic_stop_bias_map

```

```{r, echo=FALSE}
traffic_stop_bias_map
```















lower bound on legend is inclusive, upper bound exclusive




[https://geo.colorado.edu/catalog/47540-5e712aeda3d91e0009f59fc7](https://geo.colorado.edu/catalog/47540-5e712aeda3d91e0009f59fc7)



