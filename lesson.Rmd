# Loading data

Reading in data

```{r, cache=TRUE}
co_traffic_stops<-read_csv("https://www.dropbox.com/s/r7oydximjp46ylh/co_statewide_2020_04_01.csv?dl=1")
```

Printing contents of ```co_traffic_stops``` object

```{r}
co_traffic_stops
```

# Basic data cleaning and filtering

## Create a "Year" field

```{r}
# Create "year" field
co_traffic_stops<-co_traffic_stops %>% mutate(Year=substr(co_traffic_stops$date, 1,4))
```

## Filter by year

```{r}
# Filter 2010 observations and assign to a new object
co_traffic_stops_2010<-co_traffic_stops %>% filter(Year==2010)
```

## View the newly created ```co_traffic_stops_2010``` object 

```{r}
# Print contents of "co_traffic_stops_2010" object
co_traffic_stops_2010
```

# Data transformation

## Tabulate county-level count of traffice stops by race

```{r}
# Compute county-level count of traffic stops by race
co_county_summary<-co_traffic_stops_2010 %>% 
                    group_by(county_name) %>% 
                    count(subject_race) 
```

## Reshape the data

```{r}
co_county_summary_wide<-co_county_summary %>% 
                        pivot_wider(names_from=subject_race, values_from=n)
```

## Calculate total stops for each county in ```co_county_summary_wide```

```{r}
co_county_summary_wide<-co_county_summary_wide %>% 
                        rowwise() %>% 
                        mutate(total_stops=sum(c_across(where(is.integer)), na.rm=TRUE)) 
```

```{r}
co_county_summary_wide
```

## Clean ```co_county_summary_wide``` and assign to new object

```{r}
co_county_black_stops<-co_county_summary_wide %>%
                        select(county_name, black, total_stops) 
                        
```


```{r}
co_county_black_stops<-co_county_black_stops %>%
                        rename(black_stops=black)
```


```{r}
co_county_black_stops<-co_county_black_stops %>% 
                        filter(county_name!="NA")

```


```{r}
co_county_black_stops
```

# Read in and join 2010 census data to ```co_county_black_stops```

Read in census data

```{r}
# Read in census data and assigns to object named "co_counties_census_2010"
co_counties_census_2010<-read_csv("https://www.dropbox.com/s/kq94707fmcdbc0w/co_county_decennial_census.csv?dl=1") 
```

```{r}
# Prints contents of "co_counties_census_2010"
co_counties_census_2010
```

Join census data to ```co_counties_census_2010```

```{r}
co_counties_census_trafficstops<-full_join(co_county_black_stops, co_counties_census_2010,
                                           by=c("county_name"="County"))
```

```{r}
co_counties_census_trafficstops
```

# Define an index of racial bias in traffic stops

```{r}
co_counties_census_trafficstops<-co_counties_census_trafficstops %>% 
                                    mutate(black_stop_pct=((black_stops/total_stops)*100),
                                           black_pop_pct=((total_black_pop_over17/total_pop_over17)*100))
```

```{r}
co_counties_census_trafficstops
```

```{r}
co_counties_census_trafficstops<-co_counties_census_trafficstops %>% 
                                  mutate(excess_stops_index=black_stop_pct-black_pop_pct)
```

```{r}
co_counties_census_trafficstops
```

# Visualize county-level variation in the bias index using ```ggplot```

```{r}
co_counties_census_trafficstops<-co_counties_census_trafficstops %>% 
                                 mutate(County=str_remove(county_name, " County"))
```

```{r}
bias_graph<-co_counties_census_trafficstops %>% 
            drop_na(excess_stops_index) %>% 
            ggplot()+
            geom_col(aes(x=reorder(County, excess_stops_index), y=excess_stops_index))+
            coord_flip()+
            labs(title="Racial Discrimination in Police Stops, by County (Colorado)", x="County", y="Bias Index=\nBlack Percentage of Overall Traffice Stops â€“ Black Percentage of Overall Over-17 Population")+
            theme(axis.title.x = element_text(size = 9))+      
            scale_y_continuous(breaks=c(-10, -7.5, -5, -2.5, 0, 2.5, 5, 7.5))+
            expand_limits(y=c(-10,10))+
            theme(plot.title=element_text(hjust=0.5)) 
```

```{r, fig.width=8, fig.height=10}
bias_graph
```

# Join ```co_counties_census_trafficestops``` to a shapefile of Colorado counties

## Read in and view the shapefile of CO counties

```{r, echo=-1}
setwd("/Users/adra7980/Documents/CU_workshops/gis/data/tl_2019_08_county")
# Reads in shapefile and assigns to object named "co_counties_shapefile"
co_counties_shapefile<-st_read("tl_2019_08_county.shp")
```

```{r}
co_counties_shapefile
```


```{r, fig.asp=0.5, echo=-1}
tmap_mode("plot")
tm_shape(co_counties_shapefile)+
  tm_polygons()
```

```{r}
co_counties_map<-tm_shape(co_counties_shapefile)+
                    tm_polygons()
```

```{r, fig.asp=0.5}
co_counties_map
```

```{r}
tmap_mode("view")
```

```{r}
co_counties_map
```

```{r}
tmap_mode("plot")
```


```{r, fig.asp=0.5}
co_counties_map
```

## Join dataset with census and traffic stop information to shapefile

```{r}
county_shapefile_biasIndex<-full_join(co_counties_shapefile, co_counties_census_trafficstops, 
                                   by="GEOID")
```

```{r}
county_shapefile_biasIndex
```

# Mapping the Bias Index


[https://geo.colorado.edu/catalog/47540-5e712aeda3d91e0009f59fc7](https://geo.colorado.edu/catalog/47540-5e712aeda3d91e0009f59fc7)



